#!/usr/bin/env bash
#
#
# Todos:
#  + Add nemo as filemanager
#  + add mugshot to edit the user profile (default icon as .face)
#  + add menulibre for menu editing
#  + setup wisker menu
#  + setup panels
#  + setup shortcuts
#  + add note what to do manually
#

silentpacman() {
  sudo pacman --noconfirm $@
}

silentpacaur() {
  pacaur --aur --noconfirm --noedit $@
}

installPackage() {
  printf "${BLUE}Install $@...${NORMAL}\n"
  silentpacman --needed -S $@

  saveProgress $@
}

installAurPackage() {
  printf "${BLUE}Install $@...${NORMAL}\n"
  silentpacaur --needed -y $@

  saveProgress $@
}

saveProgress() {
  if [ -f $(basename "$0") ]; then
    if [ -z "$1" ]; then
      sed -i "/^\s*${FUNCNAME[ 1 ]}\$/s/^#*/#/" $(basename "$0")
    else
      sed -i "/^\s*${FUNCNAME[ 1 ]}\s+$1.*\$/s/^#*/#/" $(basename "$0")
    fi
  fi
}

installPacaur() {
  printf "${BLUE}Install pacaur...${NORMAL}\n"

  if [ -z "$(pacman -Qs pacaur)" ]; then
    mkdir -p pacaur_install
    cd pacaur_install
    # Install pacaur dependencies from arch repos
    silentpacman -S expac yajl git

    # Install "cower" from AUR
    curl -o PKGBUILD https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=cower
    makepkg PKGBUILD --skippgpcheck
    silentpacman -U cower*.tar.xz

    # Install "pacaur" from AUR
    curl -o PKGBUILD https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=pacaur
    makepkg PKGBUILD
    silentpacman -U pacaur*.tar.xz

    cd ..
    rm -rf pacaur_install
  fi

  saveProgress
}


installZsh() {
  printf "${BLUE}Install oh-my-zsh with plugins...${NORMAL}\n"
  if [ ! -f .zshrc ]; then
    silentpacman -S zsh zsh-completions
    wget -O oh-my-zsh https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh
    sudo chmod u+x oh-my-zsh
    sed -i "/env\szsh/d" oh-my-zsh

    ./oh-my-zsh
    sed -i "/^ZSH_THEME/s/\".*\"/\"gentoo\"/" ~/.zshrc
    sed -i "/^plugins/s/(.*)/(git sudo adb gradle archlinux history)/" ~/.zshrc
    mkdir -p bin
    echo "export PATH=$HOME/bin:\$PATH%" | tee ~/.zshenv

    if [ -n "$http_proxy" ]; then
      printf "${BLUE}Add proxy to default zsh profile...${NORMAL}\n"
      echo "export http_proxy=$http_proxy" | sudo tee -a /etc/zsh/zshenv
      echo "export https_proxy=$https_proxy" | sudo tee -a /etc/zsh/zshenv
    fi

    #set zsh also for root
    #sudo chsh -s $(grep /zsh$ /etc/shells | tail -1)

    echo "alias sudo='sudo '" | sudo tee -a /etc/zsh/zshenv

    #set alias to prevent official package actions through pacaur.
    #Personal setting
    echo "alias pacaur='pacaur --aur '" | sudo tee -a /etc/zsh/zshenv

    rm -rf oh-my-zsh

  else
    printf "${YELLOW}oh-my-zsh already there, using exiting one.${NORMAL}\n"
  fi

  saveProgress
}

installReflektor() {
  printf "${BLUE}Install Reflector...${NORMAL}\n"
  #Reflector for mirrorlist refreshing
  sudo cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak
  silentpacaur -S reflector-timer-weekly

  echo "Setup german filter for mirrorlist"
  sudo sed -i '/--country/d' /etc/reflector.conf
  echo "--country Germany" | sudo tee -a /etc/reflector.conf

  echo "Enable reflector service"
  sudo systemctl enable reflector.timer

  saveProgress
}

installNano(){
  printf "${BLUE}Install nano...${NORMAL}\n"
  silentpacman -S nano
  echo "export EDITOR=usr/bin/nano" | sudo tee -a /etc/zsh/zshenv

  saveProgress
}

configureNTP() {
  printf "${BLUE}Install and configure NTP...${NORMAL}\n"
  silentpacman -S ntp

  echo "Set german ntp server."
  sudo sed -i.bak '/server/d' /etc/ntp.conf
  echo "server 0.de.pool.ntp.org" | sudo tee -a /etc/ntp.conf
  echo "server 1.de.pool.ntp.org" | sudo tee -a /etc/ntp.conf
  echo "server 2.de.pool.ntp.org" | sudo tee -a /etc/ntp.conf
  echo "server 3.de.pool.ntp.org" | sudo tee -a /etc/ntp.conf

  echo "Restrict machine from being a ntp server."
  #prevent the machine from being a time server
  sudo sed -i.bak '/restrict/d' /etc/ntp.conf
  echo "restrict default nomodify nopeer" | sudo tee -a /etc/ntp.conf
  echo "restrict 127.0.0.1" | sudo tee -a /etc/ntp.conf

  echo "Enable ntp service"
  sudo systemctl enable ntpd.service

  time=$(date)
  printf "Current time: ${YELLOW}$time${NORMAL}\n"

  saveProgress
}

installBasicServiceDrivers() {
  printf "${BLUE}Install basic services and drivers...${NORMAL}\n"
  silentpacman -S acpid cups mesa-libgl avahi pulseaudio

  echo "Enable services"
  sudo systemctl enable acpid.service
  sudo systemctl enable avahi-daemon.service
  sudo systemctl enable org.cups.cupsd.service

  saveProgress
}

installLightdm() {
  printf "${BLUE}Install lightdm and gtk-greeter...${NORMAL}\n"
  silentpacman -S lightdm lightdm-gtk-greeter lightdm-gtk-greeter-settings
  sudo systemctl enable lightdm.service

  saveProgress
}

installCinnamon() {
  printf "${BLUE}Install Cinnamon...${NORMAL}\n"
  silentpacman -S cinnamon gnome-terminal

  saveProgress
}

installXfce() {
  printf "${BLUE}Install xfce...${NORMAL}\n"
  silentpacman -S xfce4 xfce4-whiskermenu-plugin

  saveProgress
}

installMaterialtheme(){
  if [ -z "$(pacman -Qs adapta-gtk-theme)" ]; then
    printf "${BLUE}Install Material Look...${NORMAL}\n"
    silentpacaur -S paper-icon-theme-git adapta-gtk-theme ttf-roboto
  fi

  printf "${BLUE}Setup Material Look...${NORMAL}\n"

  printf "${BLUE}Setup Material Look for lightdm greeter...${NORMAL}\n"
  sudo sed -i "/^#user-background/s/(true)*$/true/" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#theme-name/s/(Adapta-Nokto)*$/Adapta-Nokto/" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#icon-theme-name/s/(Paper)*$/Paper/" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#font-name/s/(Roboto\s10)*$/Roboto 10/" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#background/s/(\/usr\/share\/backgrounds\/Arch\/arch-linux-dark-colored.png)*$/\/usr\/share\/backgrounds\/Arch\/arch-linux-dark-colored.png/" /etc/lightdm/lightdm-gtk-greeter.conf

  sudo sed -i "/^#user-background/s/^#//" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#theme-name/s/^#//" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#icon-theme-name/s/^#//" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#font-name/s/^#//" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "/^#background/s/^#//" /etc/lightdm/lightdm-gtk-greeter.conf
  sudo sed -i "\$aposition = 50%,center -10,end" /etc/lightdm/lightdm-gtk-greeter.conf

  if [ ! -z "$(pacman -Qs cinnamon)" ]; then
    gsettings set org.cinnamon.desktop.interface icon-theme 'Paper'
    gsettings set org.cinnamon.desktop.interface cursor-theme "Adapta-Nokto"
    gsettings set org.cinnamon.desktop.interface gtk-theme "Adapta-Nokto"
    gsettings set org.cinnamon.desktop.wm.preferences theme "Adapta-Nokto"
    gsettings set org.cinnamon.theme name "Adapta-Nokto"
    gsettings set org.cinnamon.settings-daemon.plugins.xsettings menus-have-icons "true"

    gsettings set org.cinnamon.desktop.interface font-name "Roboto 9"
    gsettings set org.nemo.desktop font "Roboto 10"
    gsettings set org.gnome.desktop.interface document-font-name "Roboto 11"
    gsettings set org.cinnamon.desktop.wm.preferences titlebar-font "Roboto Bold 11"

    gsettings set org.cinnamon.desktop.wm.preferences button-layout "appmenu:minimize,maximize,close"

  fi

  if [ ! -z "$(pacman -Qs xfdesktop)" ]; then

      xfconf-query --create -t "string" --channel xsettings --property /Net/IconThemeName --set "Paper"
      xfconf-query --create -t "string" --channel xsettings --property /Net/ThemeName --set "Adapta-Nokto"
      xfconf-query --create -t "string" --channel xfwm4 --property /general/theme --set "Adapta-Nokto"
      xfconf-query --create -t "string" --channel xsettings --property /Gtk/CursorThemeName --set "Paper"

      xfconf-query --create -t "string" --channel xfwm4 --property /general/button_layout --set "|HMC"
      xfconf-query --create -t "string" --channel xsettings --property /Gtk/ButtonImages --set "false"
      xfconf-query --create -t "int" --channel xfwm4 --property /general/inactive_opacity --set "90"
      xfconf-query --create -t "int" --channel xfwm4 --property /general/popup_opacity --set "90"

      xfconf-query --create -t "string" --channel xsettings --property /Gtk/FontName --set "Roboto 10"
      xfconf-query --create -t "string" --channel xfwm4 --property /general/title_font --set "Roboto Bold 11"

      if [ ! -z "$(pacman -Qs compiz)" ]; then
        gsettings set org.gnome.desktop.wm.preferences theme "Adapta-Nokto"
        gsettings set org.gnome.desktop.wm.preferences titlebar-font "Roboto Bold 11"
        gsettings set org.gnome.desktop.wm.preferences button-layout "appmenu:minimize,maximize,close"
      fi

      #general settings
      printf "[Settings]\ngtk-application-prefer-dark-theme=true" | tee ~/.config/gtk-3.0/settings.ini

    #Todo add panel config from xfconf
  fi

  saveProgress
}

installCompiz() {
  printf "${BLUE}Install Compiz...${NORMAL}\n"
  silentpacaur -S compiz

  echo "compiz --replace &" | sudo tee -a /etc/xprofile

  printf "${YELLOW}Copy preset compiz profile to desktop...${NORMAL}\n"
  mkdir -p ~/Desktop
  wget -O ~/Desktop/Compiz.profile "https://raw.githubusercontent.com/Poeschl/pscripts/arch-install/Compiz.profile"

  saveProgress
}

installVirtualBoxext(){
  printf "${BLUE}Install Virtualbox Additions...${NORMAL}\n"
  silentpacman -S virtualbox-guest-modules-arch virtualbox-guest-utils
  sudo systemctl enable vboxservice.service
  sudo gpasswd -a $userName vboxsf

  saveProgress
}

installAndroidSdk() {
  printf "${BLUE}Install Android-SDK...${NORMAL}\n"
  silentpacaur -S android-sdk
  sudo groupadd androidsdk
  sudo gpasswd -a $userName androidsdk
  sudo chown -R :androidsdk /opt/android-sdk/
  sudo chmod -R g+w /opt/android-sdk/
  export ANDROID_HOME=/opt/android-sdk
  echo "export ANDROID_HOME=$ANDROID_HOME" | tee -a ~/.zshenv

  if [ -n "$http_proxy" ]; then
    #split address
    mkdir -p ~/.android/
    touch ~/.android/androidtool.cfg
    echo $http_proxy | while IFS=: read protocol ip port; do
        echo "http.proxyHost=${protocol}:${ip}" | tee -a ~/.android/androidtool.cfg
        echo "http.proxyPort=$port" | tee -a ~/.android/androidtool.cfg
    done
  fi

  echo "y" | $ANDROID_HOME/tools/android update sdk --no-ui

  saveProgress
}

installAdb() {
  printf "${BLUE}Install ADB...${NORMAL}\n"
  silentpacman -S android-tools
  #sudo gpasswd -a $userName adbusers

  saveProgress
}

configXEnvironment() {
  printf "${BLUE}Set german keyboard layout for X...${NORMAL}\n"
  sudo localectl set-x11-keymap de pc105 nodeadkeys

  printf "${BLUE}Download background...${NORMAL}\n"
  sudo mkdir -p /usr/share/backgrounds/Arch
  sudo wget -O "/usr/share/backgrounds/Arch/arch-linux-dark.png" "http://orig05.deviantart.net/e2d8/f/2010/255/2/5/arch_linux_bw_wallpaper_by_thales_img-d2yl9ul.png"
  sudo wget -O "/usr/share/backgrounds/Arch/arch-linux-dark-colored.png" "http://orig05.deviantart.net/60cc/f/2016/234/f/2/arch_linux_wallpaper_dark_by_kjeksomanen-d4a70zy.png"
  sudo wget -O "/usr/share/backgrounds/Arch/arch-linux-wall.png" "http://orig11.deviantart.net/9331/f/2015/256/2/1/archwall_by_localizator-d99ipen.png"


  if [ ! -z "$(pacman -Qs cinnamon)" ]; then
    printf "${BLUE}Enable NetworkManager...${NORMAL}\n"
    sudo systemctl enable NetworkManager.service

    if [ -n "$http_proxy" ]; then
      printf "${BLUE}Setup proxy for NetworkManager...${NORMAL}\n"
      gsettings set org.gnome.system.proxy mode 'manual'
      echo $http_proxy | while IFS=: read protocol ip port; do
        gsettings set org.gnome.system.proxy.http host "${protocol}:${ip}"
        gsettings set org.gnome.system.proxy.http port "$port"
        gsettings set org.gnome.system.proxy.https host "${protocol}:${ip}"
        gsettings set org.gnome.system.proxy.https port "$port"
      done
    fi

    printf "${BLUE}Config visual appearence...${NORMAL}\n"
    gsettings set org.nemo.desktop desktop-layout "true::true"
    gsettings set org.nemo.desktop trash-icon-visible "true"
    gsettings set org.nemo.desktop volumes-visible "true"
    gsettings set org.nemo.desktop show-orphaned-desktop-icons "true"

    printf "${BLUE}Set background...${NORMAL}\n"
    gsettings set org.cinnamon.desktop.background picture-uri  "file:////usr/share/backgrounds/Arch/arch-linux-dark.png"

    printf "<?xml version=\"1.0\"?>\<!DOCTYPE wallpapers SYSTEM \"cinnamon-wp-list.dtd\">\n
    <wallpapers>\n
      <wallpaper deleted="false">\n
        <name>Arch Linux Dark</name>\n
        <filename>/usr/share/backgrounds/Arch/arch-linux-dark.png</filename>\n
        <options>zoom</options>\n
        <shade_type>solid</shade_type>\n
        <pcolor>#000000</pcolor>\n
        <scolor>#000000</scolor>\n
      </wallpaper>\n
      <wallpaper deleted="false">\n
        <name>Arch Linux Dark Colored</name>\n
        <filename>/usr/share/backgrounds/Arch/arch-linux-dark-colored.png</filename>\n
        <options>zoom</options>\n
        <shade_type>solid</shade_type>\n
        <pcolor>#000000</pcolor>\n
        <scolor>#000000</scolor>\n
      </wallpaper>\n
      <wallpaper deleted="false">\n
        <name>Arch Linux Wall</name>\n
        <filename>/usr/share/backgrounds/Arch/arch-linux-wall.png</filename>\n
        <options>zoom</options>\n
        <shade_type>solid</shade_type>\n
        <pcolor>#000000</pcolor>\n
        <scolor>#000000</scolor>\n
      </wallpaper>\n
    </wallpapers>\n" | sudo tee /usr/share/cinnamon-background-properties/linuxarch.xml

  fi

  if [ ! -z "$(pacman -Qs xfdesktop)" ]; then
    printf "${BLUE}Set background...${NORMAL}\n"
    xfconf-query --create -t "string" --channel xfce4-desktop --property /backdrop/screen0/monitor0/workspace0/last-image  --set "/usr/share/backgrounds/Arch/arch-linux-wall.png"
  fi

  saveProgress
}

cleanup() {
  printf "${BLUE}Remove unused packages and files...${NORMAL}\n"
  if [ ! -z "$(pacman -Qtdq)" ]; then
    silentpacman -Rs $(pacman -Qtdq)
  fi

  printf "${BLUE}Remove not needed menu entries...${NORMAL}\n"
  [ -f "/usr/share/applications/qv*.desktop" ] && sudo rm /usr/share/applications/qv*.desktop
  [ -f "/usr/share/applications/electron.desktop" ] && sudo sed -i "\$aNoDisplay=true" /usr/share/applications/electron.desktop
  [ -f "/usr/share/applications/avahi-discover.desktop" ] && sudo sed -i "\$aNoDisplay=true" /usr/share/applications/avahi-discover.desktop
  [ -f "/usr/share/applications/bssh.desktop" ] && sudo sed -i "\$aNoDisplay=true" /usr/share/applications/bssh.desktop
  [ -f "/usr/share/applications/bvnc.desktop" ] && sudo sed -i "\$aNoDisplay=true" /usr/share/applications/bvnc.desktop

  saveProgress
}

installPScripts(){
  printf "${BLUE}Install pscripts...${NORMAL}\n"
  sh -c "$(wget https://raw.githubusercontent.com/Poeschl/pscripts/master/tools/install.sh -O -)"

  saveProgress
}

# Use colors, but only if connected to a terminal, and that terminal
# supports them.
if which tput >/dev/null 2>&1; then
    ncolors=$(tput colors)
fi
if [ -t 1 ] && [ -n "$ncolors" ] && [ "$ncolors" -ge 8 ]; then
  RED="$(tput setaf 1)"
  GREEN="$(tput setaf 2)"
  YELLOW="$(tput setaf 3)"
  BLUE="$(tput setaf 6)"
  BOLD="$(tput bold)"
  NORMAL="$(tput sgr0)"
else
  RED=""
  GREEN=""
  YELLOW=""
  BLUE=""
  BOLD=""
  NORMAL=""
fi

# Only enable exit-on-error after the non-critical colorization stuff,
# which may fail on systems lacking tput or terminfo
set -e

echo "This will install some tools on your system:"
echo "* Creates user and disable root from login"
echo "* pacaur"
echo "* zShell + oh-my-zsh"
echo "* Virtualbox extensions (optional)"
echo "* System tools"
echo "* Desktop Environment"
echo "* Development Environment"

read -p "Are you sure you want that? [yn] " -r
echo    # move to a new line
if [[ ! $REPLY =~ ^[Yy]$ ]];
then
  exit 1
fi

userName=$(whoami)
printf "Current user: ${YELLOW}$userName${NORMAL}\n"
cd ~

printf "${RED}It is needed to get root rights for most of the following tasks!${NORMAL}\n"
sudo echo "" > /dev/null

if [ -z "$(sudo dmidecode | grep -i Virtualbox)" ];
then
  inVM=0
else
  inVM=1
fi

ping -q -c2 archlinux.org > /dev/null
if [ $? -eq 0 ];
then
	printf "${GREEN}Internet available${NORMAL}\n"
else
  printf "${RED}No internet available, please check the connectivity and try again!${NORMAL}\n"
  exit 1
fi

# Temp raise of the /tmp/ folder size to 2GiB
sudo mount -o remount,size=2G,noatime /tmp

printf "${BLUE}Sync packages database...${NORMAL}\n"
silentpacman -Syy

installZsh
installNano
installPackage htop
installPacaur
installReflektor
configureNTP
installBasicServiceDrivers

installLightdm

if [ inVM=1 ];
then
  printf "${BLUE}Virtual Environment detected${NORMAL}\n"
  installXfce
  installCompiz
  installVirtualBoxext
else
  printf "${BLUE}Bare hardware Environment${NORMAL}\n"
  installCinnamon
fi

installPackage system-config-printer gnome-keyring
configXEnvironment
installMaterialtheme

installPackage gedit
installPackage eog
installPackage gnome-calculator
installAurPackage google-chrome
installPackage atom
installPackage jdk8-openjdk
installPackage intellij-idea-community-edition
installAndroidSdk
installAdb
installAurPackage android-studio
installPScripts
installPackage audacious
installPackage vlc qt4

cleanup

printf "${YELLOW}Installed tools!\nPlease re-login to apply the made changes to your shell.\n And restart to see your new desktop environment.${NORMAL}\n"
